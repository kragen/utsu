<html>
<script type="text/javascript">
    this.storage = {
        'get': function(key) {
            return localStorage[key];
        },
        'set': function(key, value) {
            localStorage[key] = value;
        }
    }
    
    function getCurrentTabInfo(callback) {
        chrome.tabs.getSelected(null, function(tab) {
            callback(tab);
        });
    }
    
    function saveNotes(notes) {
        getCurrentTabInfo(function(tab) {
            storage.set(tab.url, notes);
            refresh();
        });
    }
    
    function refresh() {
        getCurrentTabInfo(function(tab) {
            var icon = 'no-notes.png';
            if(storage.get(tab.url)) {
                icon = 'has-notes.png';
            }
            chrome.browserAction.setIcon({
              'path': icon,
              'tabId': tab.id
            });
        });
    }
    
    ['onSelectionChanged', 'onCreated', 'onUpdated'].forEach(function(e) {
      chrome.tabs[e].addListener(refresh);
    });
    
    refresh();
</script>
</html>