<html>
<script type="text/javascript">
    this.storage = {
        'get': function(key) {
            return localStorage[key];
        },
        'set': function(key, value) {
            localStorage[key] = value;
        }
    }
    
    function getCurrentTabInfo(callback) {
        chrome.tabs.getSelected(null, function(tab) {
            callback(tab);
        });
    }
    
    function saveNotes(notes) {
        getCurrentTabInfo(function(tab) {
            storage.set(tab.url, notes);
            refresh();
        });
    }
    
    function refresh() {
        getCurrentTabInfo(function(tab) {
            var icon = 'no-notes.png';
            if(storage.get(tab.url)) {
                icon = 'has-notes.png';
            }
            chrome.browserAction.setIcon({
              'path': icon,
              'tabId': tab.id
            });
        });
    }
    
    function omniboxChanged(text, suggest) {
        if(text === '') return;
        
        var urls = Object.keys(localStorage);
        var suggestions = [];
        urls.forEach(function(url) {
          if(url.match(text)) {
            var content = storage.get(url);
            var description = '<url>' + content + '</url>';
            description += '<dim> - ' + url + '</dim>';
            suggestions.push({
              'description': description,
              'content': url,
            });
          }
        });
        
        if(suggestions.length) suggest(suggestions);
    }
    
    ['onSelectionChanged', 'onCreated', 'onUpdated'].forEach(function(e) {
      chrome.tabs[e].addListener(refresh);
    });
    
    chrome.omnibox.onInputChanged.addListener(omniboxChanged);
    
    refresh();
</script>
</html>